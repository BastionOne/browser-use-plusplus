<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scenario 5 – Orders Table</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        background: #f1f5f9;
        color: #0f172a;
        min-height: 100vh;
        padding: 32px;
      }

      h1 {
        margin-top: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      }

      th,
      td {
        padding: 14px 16px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      button {
        border-radius: 6px;
        border: none;
        cursor: pointer;
        padding: 6px 10px;
      }

      .inline-details {
        background: #f8fafc;
        display: none;
      }

      .inline-details td {
        font-size: 0.9rem;
        color: #475569;
      }

      .inline-details.open {
        display: table-row;
      }

      .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 360px;
        height: 100%;
        background: #0f172a;
        color: #e2e8f0;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        padding: 28px;
        box-shadow: -10px 0 30px rgba(15, 23, 42, 0.4);
      }

      .drawer.open {
        transform: translateX(0%);
      }

      .drawer h2 {
        margin-top: 0;
      }

      .log {
        margin-top: 24px;
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        font-family: "Fira Code", Consolas, monospace;
        max-height: 220px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>Orders</h1>
    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
    <div class="log" id="logPanel" aria-live="polite">Loading orders…</div>
    <aside class="drawer" id="drawer">
      <div>
        <h2>Order timeline</h2>
        <button id="closeDrawer">Close</button>
        <div id="drawerContent"></div>
      </div>
    </aside>
    <script>
      const body = document.getElementById("ordersBody");
      const logPanel = document.getElementById("logPanel");
      const drawer = document.getElementById("drawer");
      const drawerContent = document.getElementById("drawerContent");
      const closeDrawer = document.getElementById("closeDrawer");

      function log(message) {
        const entry = document.createElement("div");
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logPanel.prepend(entry);
      }

      async function loadOrders() {
        log("GET /api/orders?summary=true");
        const response = await fetch("/api/orders?summary=true");
        const data = await response.json();
        log(`Response: ${JSON.stringify(data)}`);
        body.innerHTML = "";
        data.orders.forEach((order) => {
          const row = document.createElement("tr");
          row.dataset.orderId = order.id;
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.customer}</td>
            <td>${order.total}</td>
            <td>${order.status}</td>
            <td class="actions">
              <button data-action="expand">Expand</button>
              <button data-action="details">Details</button>
            </td>
          `;
          body.appendChild(row);
          const detailRow = document.createElement("tr");
          detailRow.className = "inline-details";
          detailRow.dataset.orderId = order.id;
          detailRow.innerHTML = `<td colspan="5">Loading details…</td>`;
          body.appendChild(detailRow);
        });
      }

      body.addEventListener("click", async (event) => {
        const action = event.target.dataset.action;
        if (!action) return;
        const row = event.target.closest("tr");
        const orderId = row?.dataset.orderId;
        if (!orderId) return;

        if (action === "expand") {
          const inline = body.querySelector(`.inline-details[data-order-id="${orderId}"]`);
          const isOpen = inline.classList.toggle("open");
          if (isOpen) {
            log(`GET /api/orders/${orderId}/details`);
            const response = await fetch(`/api/orders/${orderId}/details`);
            const data = await response.json();
            log(`Response: ${JSON.stringify(data)}`);
            inline.innerHTML = `<td colspan="5">${data.details}</td>`;
          }
        } else if (action === "details") {
          await openDrawer(orderId);
        }
      });

      async function openDrawer(orderId) {
        log(`GET /api/orders/${orderId}/timeline`);
        log(`GET /api/orders/${orderId}/audit-log`);
        const [timelineRes, auditRes] = await Promise.all([
          fetch(`/api/orders/${orderId}/timeline`),
          fetch(`/api/orders/${orderId}/audit-log`),
        ]);
        const timeline = await timelineRes.json();
        const audit = await auditRes.json();
        log(`Timeline: ${JSON.stringify(timeline)}`);
        log(`Audit log: ${JSON.stringify(audit)}`);
        drawerContent.innerHTML = `
          <h3>Timeline</h3>
          <ul>${timeline.events.map((event) => `<li>${event}</li>`).join("")}</ul>
          <h3>Audit Log</h3>
          <ul>${audit.entries.map((entry) => `<li>${entry}</li>`).join("")}</ul>
        `;
        drawer.classList.add("open");
      }

      closeDrawer.addEventListener("click", () => drawer.classList.remove("open"));

      loadOrders();
    </script>
  </body>
</html>
